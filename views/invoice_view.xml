<openerp>
    <data>
        <!-- Inherit quotation report (from module sale) -->
        <template id="report_invoice_payment_advice">
	    <!-- Finds the first table with as class table table-sm o_main_table and gives the ability to modify it
		 This will replace everything withing tr (including tr)-->
		  <t t-call="web.html_container">			
            <t t-call="web.external_layout">
				<t t-foreach="docs" t-as="o">
                <t t-set="o" t-value="o.with_context(lang=lang)"/>
                <t t-set="forced_vat" t-value="o.fiscal_position_id.foreign_vat"/> <!-- So that it appears in the footer of the report instead of the company VAT if it's set -->
                <div class="row">
                    
                        <div class="offset-col-6 col-6" name="no_shipping">
                        <t t-set="address">
                            <address class="mb-0" t-field="o.partner_id" t-options="{&quot;widget&quot;: &quot;contact&quot;, &quot;fields&quot;: [&quot;address&quot;, &quot;name&quot;], &quot;no_marker&quot;: True}"/>
                            <div t-if="o.partner_id.vat">
                                <t t-if="o.company_id.account_fiscal_country_id.vat_label" t-esc="o.company_id.account_fiscal_country_id.vat_label" id="inv_tax_ids_label"/>
                                <t t-else="">Tax ID</t>: <span t-field="o.partner_id.vat"/>
                            </div>
                        </t>
                        </div>
                  
                </div>
                <div class="mt-5">
                    <div class="page">
                        <h2>
                            <span t-if="o.move_type == 'in_invoice'">Payment Advice</span>
                            <span t-if="o.name != '/'" t-field="o.name"/>
                        </h2>

                        <div id="informations" class="row mt-4 mb-4">
                            <div class="col-auto col-3 mw-100 mb-2" t-if="o.invoice_date" name="invoice_date">
                                <strong>Date:</strong>
                                <p class="m-0" t-field="o.invoice_date"/>
                            </div>
                            <div class="col-auto col-3 mw-100 mb-2" t-if="o.invoice_date_due and o.move_type == 'out_invoice' and o.state == 'posted'" name="due_date">
                                <strong>Due Date:</strong>
                                <p class="m-0" t-field="o.invoice_date_due"/>
                            </div>
                            <div class="col-auto col-3 mw-100 mb-2" t-if="o.invoice_origin" name="origin">
                                <strong>Source:</strong>
                                <p class="m-0" t-field="o.invoice_origin"/>
                            </div>
                            <div class="col-auto col-3 mw-100 mb-2" t-if="o.partner_id.nhis_ref" name="customer_code">
                                <strong>NHIS Ref:</strong>
                                <p class="m-0" t-field="o.partner_id.nhis_ref"/>
                            </div>
                            <div class="col-auto col-3 mw-100 mb-2" t-if="o.ref" name="reference">
                                <strong>Reference:</strong>
                                <p class="m-0" t-field="o.ref"/>
                            </div>
                        </div>

                        <t t-set="display_discount" t-value="any(l.discount for l in o.invoice_line_ids)"/>

                        <table class="table table-sm o_main_table table-borderless" name="invoice_line_table">
                            <thead>
                                <tr style="background-color:lightgray;">
									<th>Date</th>
									<th>Enrollee Name/Number</th>
									<th>Diagnosis</th>
									<th>Treatment</th>
									<th>Provider Cost</th>
									<th>Approved Cost</th>
								</tr>
                            </thead>
                            <tbody class="invoice_tbody">
                                <t t-set="current_subtotal" t-value="0"/>
								<t t-set="cell" t-value="0" /> 
								  <t t-set="cnt" t-value="1" /> 
								  <t t-set="provp" t-value="0" /> 
								  <t t-set="subt" t-value="0" /> 
								  <t t-set="total_prov" t-value="0" /> 
								  <t t-set="total_sub" t-value="0" /> 
								  <t t-set="orig" t-value="ZZ" /> 
                                <t t-set="lines" t-value="o.invoice_line_ids.sorted(key=lambda l: (-l.sequence, l.date, l.move_name, -l.id), reverse=True)"/>

                               <tr t-foreach="lines" t-as="l">
									<t t-if="cnt == 1"> 
										<td>
											
											<span t-field="l.line_date" t-options='{"format": "dd/MM/yyyy"}'/>
										</td>
										<td>
											  <span t-field="l.enrollee_id.code"/> <span t-field="l.enrollee_id.surname"/> <span t-field="l.enrollee_id.firstname"/>
										</td>
										<td>
											<t t-if="l.purchase_line_id.order_id.diagnosis_lines">
												<table class="table table-sm o_main_table">
											
													<tr t-foreach="l.purchase_line_id.order_id.diagnosis_lines" t-as="m">
													   <td>
															<span t-field="m.icd_id.name"/>
													   </td>
													</tr>
												
												</table>
											</t>
										</td>
										<td>
											<span t-field="l.name"/>
										</td>
										
												 
										<td>
											<span t-field="l.provider_cost" t-field-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: &quot;o.currency_id&quot;}"/>
										</td>
										<td>
											<span t-field="l.price_subtotal" t-field-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: &quot;o.currency_id&quot;}"/>
										</td>
									</t>
									
									<t t-if="not cnt == 1"> 
										<t t-if="l.purchase_id.name == orig"> 
												<td>
													<span t-field="l.line_date" t-options='{"format": "dd/MM/yyyy"}'/>
												</td>
												<td>
													  <span t-field="l.enrollee_id.code"/> <span t-field="l.enrollee_id.surname"/> <span t-field="l.enrollee_id.firstname"/>
												</td>
												<td>
													<span/>
												</td>
												<td>
													<span t-field="l.name"/>
												</td>
														 
												<td>
													<span t-field="l.provider_cost" t-field-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: &quot;o.currency_id&quot;}"/>
												</td>
												<td >
													<span t-field="l.price_subtotal" t-field-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: &quot;o.currency_id&quot;}"/>
												</td>									
										</t>
										
										<t t-if="not l.purchase_id.name == orig"> 
												<td>
													<span />
												</td>
												<td>
													  <span />
												</td>
												<td>
													<span />
												</td>
												<td>
													<strong>Sub-Total</strong> 
												</td>
													
												<td>
													<strong><span t-esc="'{0:,.2f}'.format(int(provp))"/></strong>
												</td>
												<td>
													<strong><span t-esc="'{0:,.2f}'.format(int(subt))"/></strong>
												</td>
												
											   <t t-set="provp" t-value="0" /> 
											   <t t-set="subt" t-value="0" /> 
											   <tr>
													<td>
														<span t-field="l.line_date" t-options='{"format": "dd/MM/yyyy"}'/>
													</td>
													<td>
														  <span t-field="l.enrollee_id.code"/> <span t-field="l.enrollee_id.surname"/> <span t-field="l.enrollee_id.firstname"/>
													</td>
													<td>
														<table class="table table-sm o_main_table">
										
												<tr t-foreach="l.purchase_line_id.order_id.diagnosis_lines" t-as="m">
												   <td>
														<span t-field="m.icd_id.name"/>
												   </td>
												</tr>
											
											</table>
													</td>
													<td>
														<span t-field="l.name"/>
													</td>
															 
													<td>
														<span t-field="l.provider_cost" t-field-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: &quot;o.currency_id&quot;}"/>
													</td>
													<td >
														<span t-field="l.price_subtotal" t-field-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: &quot;o.currency_id&quot;}"/>
													</td>		
											   
											   </tr>
												
										</t>
										
									</t>
									<t t-set="provp" t-value="l.provider_cost + provp" /> 
									<t t-set="subt" t-value="l.price_subtotal + subt" /> 
								<t t-set="total_prov" t-value="total_prov + l.provider_cost" /> 
								  <t t-set="total_sub" t-value="l.price_subtotal + total_sub" /> 
								   <t t-set="orig" t-value="l.purchase_id.name" /> 
								   <t t-set="cnt" t-value="4" /> 
								</tr>
								<tr>
												
												<td>
													  <span />
												</td>
												<td>
													<span />
												</td>
												<td>
													<span />
												</td>
												<td>
													<strong>Sub-Total</strong> 
												</td>
													
												<td>
													<strong><span t-esc="'{0:,.2f}'.format(int(provp))"/></strong>
												</td>
												<td>
													<strong><span t-esc="'{0:,.2f}'.format(int(subt))"/></strong>
												</td>
												
								</tr>
													<tr>
												<td>
													<span />
												</td>
												<td>
													  <span />
												</td>
												<td>
													<br/>
												</td>
													
												<td>
													<br/>
												</td>
												<td>
												<br/>
												</td>
												<td>
													<span />
												</td>
								</tr>
								<tr>
												<td>
													<span />
												</td>
												<td>
													  <span />
												</td>
												<td>
													<span />
												</td>
												<td>
													<strong>TOTAL</strong> 
												</td>
													
												<td>
													<strong><span t-esc="'{0:,.2f}'.format(int(total_prov))"/></strong>
												</td>
												<td>
													<strong><span t-field="o.currency_id.symbol"/><span t-esc="'{0:,.2f}'.format(int(total_sub))" /></strong>
											</td>
											
								</tr>
							
								<tr>
												<td>
													<span />
												</td>
												<td>
													  <span />
												</td>
												<td>
													<br/>
												</td>
													
												<td>
													<br/>
												</td>
												<td>
												<br/>
												</td>
												<td>
													<span />
												</td>
								</tr>
								
							
							</tbody>
                        </table>

                   
                    </div>
                    
                    
                    <div t-if="not is_html_empty(o.narration)" name="comment">
                        <span t-field="o.narration"/>
                    </div>
                    <p t-if="not is_html_empty(o.fiscal_position_id.note)" name="note">
                        <span t-field="o.fiscal_position_id.note"/>
                    </p>
                    
                </div>
            </t>
        </t>
		</t>
        </template>
    </data>
</openerp>